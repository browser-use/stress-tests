<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TanStack Form</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      // Simple polyfill for useForm since TanStack Form doesn't have a simple UMD build
      window.TanStackReactForm = {
        useForm: function(options) {
          const [formState, setFormState] = React.useState(options.defaultValues || {});
          const [errors, setErrors] = React.useState({});
          const [touched, setTouched] = React.useState({});

          const validateField = (name, value, validators) => {
            if (!validators) return undefined;

            if (validators.onChange) {
              return validators.onChange({ value });
            }

            if (validators.onBlur) {
              return validators.onBlur({ value });
            }

            return undefined;
          };

          const validateAllFields = (fields) => {
            const newErrors = {};
            let hasErrors = false;

            Object.keys(fields).forEach(fieldName => {
              const fieldConfig = fields[fieldName];
              const value = formState[fieldName];

              if (fieldConfig && fieldConfig.validators) {
                const error = validateField(fieldName, value, fieldConfig.validators);
                if (error) {
                  newErrors[fieldName] = error;
                  hasErrors = true;
                }
              }
            });

            return { errors: newErrors, hasErrors };
          };

          const handleSubmit = (fields) => {
            // Validate all fields before submit
            const { errors: validationErrors, hasErrors } = validateAllFields(fields);
            setErrors(validationErrors);

            // Mark all fields as touched
            const allTouched = {};
            Object.keys(fields).forEach(key => {
              allTouched[key] = true;
            });
            setTouched(allTouched);

            if (!hasErrors && options.onSubmit) {
              options.onSubmit({ value: formState });
            }
          };

          const Field = ({ name, validators, children }) => {
            const handleChange = (value) => {
              setFormState(prev => ({ ...prev, [name]: value }));

              // Validate on change if field has been touched
              if (touched[name] && validators) {
                const error = validateField(name, value, validators);
                setErrors(prev => ({ ...prev, [name]: error }));
              }
            };

            const handleBlur = () => {
              setTouched(prev => ({ ...prev, [name]: true }));

              // Validate on blur
              if (validators) {
                const value = formState[name];
                const error = validateField(name, value, validators);
                setErrors(prev => ({ ...prev, [name]: error }));
              }
            };

            const field = {
              name,
              state: {
                value: formState[name] !== undefined ? formState[name] : '',
                meta: {
                  errors: touched[name] ? (errors[name] ? [errors[name]] : []) : [],
                  isTouched: touched[name] || false
                }
              },
              handleChange,
              handleBlur
            };

            return children(field);
          };

          const Subscribe = ({ selector, children }) => {
            const canSubmit = Object.keys(errors).length === 0;
            const isSubmitting = false;
            return children(selector({ canSubmit, isSubmitting }));
          };

          return {
            Field,
            Subscribe,
            handleSubmit,
            reset: () => {
              setFormState(options.defaultValues || {});
              setErrors({});
              setTouched({});
            }
          };
        }
      };
    </script>
    <script>
      console.log('Page loading, scripts loading');
      window.addEventListener('error', (event) => {
        console.error('Global error caught:', event.error);
      });
    </script>
    <style>
        .form-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            color: #0d6efd;
        }
        
        .error-text {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
        
        .invalid-field {
            border-color: #dc3545;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-header h4 {
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-4 mb-4">TanStack Form</h1>
        <p>This is a fully interactive React component using TanStack Form for validation.</p>
        
        <div id="tanstack-form-root"></div>
    </div>
    
    <script type="text/babel">
        // Use global React, ReactDOM, and polyfilled TanStack Form
        const { useState } = React;
        const { createRoot } = ReactDOM;
        const { useForm } = TanStackReactForm;
        
        console.log('Module script loaded', { React, ReactDOM, createRoot, useForm });
        
        // Create the TanStack Form component
        function TanStackFormApp() {
            const [showSuccess, setShowSuccess] = useState(false);

            // Field configurations with validators
            const fieldConfigs = {
                email: {
                    validators: {
                        onChange: ({ value }) => {
                            if (!value || value.trim() === '') {
                                return 'Email is required';
                            }
                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            if (!emailRegex.test(value)) {
                                return 'Please enter a valid email address';
                            }
                            return undefined;
                        }
                    }
                },
                department: {
                    validators: {
                        onChange: ({ value }) => {
                            if (!value || value === '') {
                                return 'Please select a department';
                            }
                            return undefined;
                        }
                    }
                },
                startDate: {
                    validators: {
                        onChange: ({ value }) => {
                            if (!value || value.trim() === '') {
                                return 'Start date is required';
                            }
                            return undefined;
                        }
                    }
                },
                preferredWorkTime: {
                    validators: {
                        onChange: ({ value }) => {
                            if (!value || value.trim() === '') {
                                return 'Please select a preferred work time';
                            }
                            return undefined;
                        }
                    }
                },
                resume: {
                    validators: {
                        onChange: ({ value }) => {
                            if (!value) {
                                return 'Please upload your resume';
                            }
                            return undefined;
                        }
                    }
                }
            };

            // Define form using TanStack Form
            const form = useForm({
                defaultValues: {
                    email: '',
                    department: '',
                    startDate: '',
                    preferredWorkTime: '',
                    resume: null
                },
                onSubmit: async ({ value }) => {
                    console.log('Form submitted successfully! The secret is: dumbledore', value);
                    setShowSuccess(true);
                }
            });

            return (
                <>
                    {showSuccess && (
                        <div className="alert alert-success">
                            <strong>Success!</strong> Form submitted successfully! The secret is: dumbledore
                        </div>
                    )}

                    <form
                        className="form-container"
                        id="tanstack-form"
                        onSubmit={(e) => {
                            e.preventDefault();
                            form.handleSubmit(fieldConfigs);
                        }}
                    >
                        <div className="form-section">
                            <h3>Application Form</h3>

                            {/* Email Field */}
                            <div className="mb-3">
                                <form.Field name="email" validators={fieldConfigs.email.validators}>
                                    {(field) => (
                                        <>
                                            <label htmlFor="email" className="form-label">
                                                Email Address <span className="text-danger">*</span>
                                            </label>
                                            <input
                                                type="email"
                                                id="email"
                                                className={`form-control ${field.state.meta.errors.length > 0 ? 'invalid-field' : ''}`}
                                                value={field.state.value}
                                                onChange={(e) => field.handleChange(e.target.value)}
                                                onBlur={field.handleBlur}
                                                required
                                            />
                                            {field.state.meta.errors.length > 0 && (
                                                <div className="error-text">{field.state.meta.errors[0]}</div>
                                            )}
                                        </>
                                    )}
                                </form.Field>
                            </div>

                            {/* Department Dropdown */}
                            <div className="mb-3">
                                <form.Field name="department" validators={fieldConfigs.department.validators}>
                                    {(field) => (
                                        <>
                                            <label htmlFor="department" className="form-label">
                                                Department <span className="text-danger">*</span>
                                            </label>
                                            <select
                                                id="department"
                                                className={`form-select ${field.state.meta.errors.length > 0 ? 'invalid-field' : ''}`}
                                                value={field.state.value}
                                                onChange={(e) => field.handleChange(e.target.value)}
                                                onBlur={field.handleBlur}
                                                required
                                            >
                                                <option value="">Select Department</option>
                                                <option value="engineering">Engineering</option>
                                                <option value="marketing">Marketing</option>
                                                <option value="sales">Sales</option>
                                                <option value="hr">Human Resources</option>
                                            </select>
                                            {field.state.meta.errors.length > 0 && (
                                                <div className="error-text">{field.state.meta.errors[0]}</div>
                                            )}
                                        </>
                                    )}
                                </form.Field>
                            </div>

                            {/* Start Date Picker */}
                            <div className="mb-3">
                                <form.Field name="startDate" validators={fieldConfigs.startDate.validators}>
                                    {(field) => (
                                        <>
                                            <label htmlFor="startDate" className="form-label">
                                                Start Date <span className="text-danger">*</span>
                                            </label>
                                            <input
                                                type="date"
                                                id="startDate"
                                                className={`form-control ${field.state.meta.errors.length > 0 ? 'invalid-field' : ''}`}
                                                value={field.state.value}
                                                onChange={(e) => field.handleChange(e.target.value)}
                                                onBlur={field.handleBlur}
                                                required
                                            />
                                            {field.state.meta.errors.length > 0 && (
                                                <div className="error-text">{field.state.meta.errors[0]}</div>
                                            )}
                                        </>
                                    )}
                                </form.Field>
                            </div>

                            {/* Preferred Work Time Radio Buttons */}
                            <div className="mb-3">
                                <form.Field name="preferredWorkTime" validators={fieldConfigs.preferredWorkTime.validators}>
                                    {(field) => (
                                        <>
                                            <label className="form-label">Preferred Work Time <span className="text-danger">*</span></label>
                                            <div>
                                                <div className="form-check">
                                                    <input
                                                        type="radio"
                                                        id="morning"
                                                        name="preferredWorkTime"
                                                        className="form-check-input"
                                                        value="morning"
                                                        checked={field.state.value === 'morning'}
                                                        onChange={(e) => field.handleChange(e.target.value)}
                                                        onBlur={field.handleBlur}
                                                        required
                                                    />
                                                    <label htmlFor="morning" className="form-check-label">
                                                        Morning (9 AM - 1 PM)
                                                    </label>
                                                </div>
                                                <div className="form-check">
                                                    <input
                                                        type="radio"
                                                        id="afternoon"
                                                        name="preferredWorkTime"
                                                        className="form-check-input"
                                                        value="afternoon"
                                                        checked={field.state.value === 'afternoon'}
                                                        onChange={(e) => field.handleChange(e.target.value)}
                                                        onBlur={field.handleBlur}
                                                        required
                                                    />
                                                    <label htmlFor="afternoon" className="form-check-label">
                                                        Afternoon (1 PM - 5 PM)
                                                    </label>
                                                </div>
                                                <div className="form-check">
                                                    <input
                                                        type="radio"
                                                        id="evening"
                                                        name="preferredWorkTime"
                                                        className="form-check-input"
                                                        value="evening"
                                                        checked={field.state.value === 'evening'}
                                                        onChange={(e) => field.handleChange(e.target.value)}
                                                        onBlur={field.handleBlur}
                                                        required
                                                    />
                                                    <label htmlFor="evening" className="form-check-label">
                                                        Evening (5 PM - 9 PM)
                                                    </label>
                                                </div>
                                            </div>
                                            {field.state.meta.errors.length > 0 && (
                                                <div className="error-text">{field.state.meta.errors[0]}</div>
                                            )}
                                        </>
                                    )}
                                </form.Field>
                            </div>

                            {/* File Upload */}
                            <div className="mb-3">
                                <form.Field name="resume" validators={fieldConfigs.resume.validators}>
                                    {(field) => (
                                        <>
                                            <label htmlFor="resume" className="form-label">
                                                Upload Resume <span className="text-danger">*</span>
                                            </label>
                                            <input
                                                type="file"
                                                id="resume"
                                                className={`form-control ${field.state.meta.errors.length > 0 ? 'invalid-field' : ''}`}
                                                onChange={(e) => field.handleChange(e.target.files[0])}
                                                onBlur={field.handleBlur}
                                                required
                                            />
                                            {field.state.meta.errors.length > 0 && (
                                                <div className="error-text">{field.state.meta.errors[0]}</div>
                                            )}
                                        </>
                                    )}
                                </form.Field>
                            </div>
                        </div>

                        {/* Submit Button */}
                        <div className="mb-3">
                            <form.Subscribe
                                selector={(state) => [state.canSubmit, state.isSubmitting]}
                            >
                                {([canSubmit, isSubmitting]) => (
                                    <button
                                        type="submit"
                                        className="btn btn-primary"
                                        disabled={!canSubmit || isSubmitting}
                                    >
                                        {isSubmitting ? 'Submitting...' : 'Submit Form'}
                                    </button>
                                )}
                            </form.Subscribe>
                        </div>
                    </form>
                </>
            );
        }
        
        // Render the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            const rootElement = document.getElementById('tanstack-form-root');
            console.log('Root element:', rootElement);
            
            try {
                console.log('Using modern createRoot API');
                const root = createRoot(rootElement);
                console.log('Root created successfully');
                root.render(React.createElement(TanStackFormApp));
                console.log('Render called with createElement');
            } catch (error) {
                console.error('Error with createRoot:', error);
                console.log('Falling back to legacy render');
                try {
                    ReactDOM.render(React.createElement(TanStackFormApp), rootElement);
                    console.log('Legacy render called');
                } catch (fallbackError) {
                    console.error('Even legacy render failed:', fallbackError);
                }
            }
        });
        
        // Fallback for immediate execution
        console.log('Script loaded, checking if DOM is already ready');
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            console.log('DOM already ready, trying to render immediately');
            setTimeout(() => {
                try {
                    const rootElement = document.getElementById('tanstack-form-root');
                    console.log('Root element (immediate):', rootElement);
                    const root = createRoot(rootElement);
                    root.render(<TanStackFormApp />);
                    console.log('Immediate render called');
                } catch (error) {
                    console.error('Error in immediate render:', error);
                }
            }, 0);
        }
    </script>
</body>
</html>
